name: Get Twitch M3U8 URL and Commit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

concurrency:
  group: commit-to-master
  cancel-in-progress: false

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: |
          sudo apt update
          sudo apt install -y streamlink
      - run: |
          git clone --depth=1 https://x-access-token:${{ secrets.TOKEN_PRIVATE }}@github.com/${{ secrets.REPO_PRIVATE }} private
          cp private/channel.txt $HOME/channel.txt
      - run: python pesawatsry.py
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -u
          if git diff --cached --quiet; then
            echo "✅ Tidak ada perubahan"
          else
            git commit -m "Update Twitch M3U8 URL"
            git pull --rebase origin master || echo "⚠️ Pull gagal"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:master || echo "⚠️ Push gagal"
          fi
